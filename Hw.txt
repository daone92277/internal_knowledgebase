-- Monday thru Thursday
-- 1.  Get Transmissions with Counts - Monday thru Thursday - Schedule:  Run at 12:50PM
SELECT etc.EFTTransmissionId, DrawDate, BankId, TransmissionStatusCode, RequestTypeCode, Count(*) as Count,
		sum(cast(EFTTransmissionData as xml).value('(/EFTTransmissionData/Amount)[1]','decimal(19,4)')) as Amount
from DC_BIL_EFTTransmissionControl etc
join DC_BIL_EFTTransmissionRequest etr
on etc.EFTTransmissionId = etr.EFTTransmissionId
where ((drawdate <= CONVERT(date, getdate()) and BankId = 5) or
      (drawdate <= CONVERT(date, getdate()+1) and BankId = 1))
and TransmissionStatusCode in ('A','I') 
and StatusCode in ('A','I')
group by etc.EFTTransmissionId, DrawDate, BankId, TransmissionStatusCode, RequestTypeCode
order by BankId, EFTTransmissionId

-- 2.  Get Transmissions with both Debit and Credit
select EFTTransmissionId, count(distinct RequestTypeCode) as CountRequestTypeCode
from DC_BIL_EFTTransmissionRequest
where EFTTransmissionId in (
		select EFTTransmissionId from DC_BIL_EFTTransmissionControl 
		where ((drawdate <= CONVERT(date, getdate()) and BankId = 5) or
			(drawdate <= CONVERT(date, getdate()+1) and BankId = 1))
			and TransmissionStatusCode in ('A','I') )
and StatusCode in ('A','I')
group by EFTTransmissionId
having count(distinct RequestTypeCode) > 1
order by 1,2

-- 3.  Get Transmissions with Both EFT and RCC - Monday thru Thursday
select etc.EFTTransmissionId, PaymentMethodCode, count(*) as Count,
		sum(cast(EFTTransmissionData as xml).value('(/EFTTransmissionData/Amount)[1]','decimal(19,4)')) as Amount
from PRD_DuckCreek_Consolidated.dbo.DC_BIL_EFTTransmissionControl etc with(nolock)
join PRD_DuckCreek_Consolidated.dbo.DC_BIL_EFTTransmissionRequest etr with(nolock)
on etc.EFTTransmissionId = etr.EFTTransmissionId
and etc.EFTTransmissionId in (
		SELECT EFTTransmissionId
		from DC_BIL_EFTTransmissionControl 
		where ((drawdate <= CONVERT(date, getdate()) and BankId = 5) or
	      (drawdate <= CONVERT(date, getdate()+1) and BankId = 1))
		and TransmissionStatusCode in ('A','I')) 
and etr.StatusCode in ('A','I')
group by etc.EFTTransmissionId, PaymentMethodCode
order by etc.EFTTransmissionId, PaymentMethodCode

-- 4.  Bank Id Problem
select * from [PRD_DuckCreek_Consolidated].[dbo].[DC_BIL_EFTTransmissionRequest] a ,
[PRD_DuckCreek_Consolidated].[dbo].DC_BIL_EFTTransmissionControl b
where a.EFTTransmissionId=b.EFTTransmissionId and b.BankId='1' and a.PaymentMethodCode NOT IN ( '1EFT','EFT');

-- 5.  Multiple Transmissions with Same Draw Date, Bank Id, Request Type Code
select *
from DC_BIL_EFTTransmissionControl etc2
where etc2.TransmissionStatusCode in ('A','I')
and exists
(
SELECT DrawDate, BankId, TransmissionStatusCode, RequestTypeCode, Count(distinct etc.EFTTransmissionId) as Count
from DC_BIL_EFTTransmissionControl etc
join DC_BIL_EFTTransmissionRequest etr
on etc.EFTTransmissionId = etr.EFTTransmissionId
where ((drawdate <= CONVERT(date, getdate()) and BankId = 5) or
      (drawdate <= CONVERT(date, getdate()+1) and BankId = 1))
and TransmissionStatusCode in ('A','I') 
and StatusCode in ('A','I')
and etc.DrawDate = etc2.DrawDate
and etc.BankId = etc.Bankid
group by DrawDate, BankId, TransmissionStatusCode, RequestTypeCode
having Count(distinct etc.EFTTransmissionId) > 1)


--  6. ACH Payment with empty Bank Account Number/Bank Routing Number
select top 1000
cast(EFTTransmissionData as xml).value('(/EFTTransmissionData/BankAccountNumber)[1]','nvarchar(max)'),
cast(EFTTransmissionData as xml).value('(/EFTTransmissionData/BankRoutingNumber)[1]','nvarchar(max)'),
*
from PRD_DuckCreek_Consolidated.dbo.DC_BIL_EFTTransmissionRequest eft with(nolock)
where statuscode in ('A','I')
and PaymentMethodCode in ('EFT','1EFT')
and (cast(EFTTransmissionData as xml).value('(/EFTTransmissionData/BankAccountNumber)[1]','nvarchar(max)') = ''
or cast(EFTTransmissionData as xml).value('(/EFTTransmissionData/BankRoutingNumber)[1]','nvarchar(max)') = ''
or cast(EFTTransmissionData as xml).value('(/EFTTransmissionData/BankAccountNumber)[1]','nvarchar(max)') is NULL
or cast(EFTTransmissionData as xml).value('(/EFTTransmissionData/BankRoutingNumber)[1]','nvarchar(max)') is NULL)

--  7.  CC Payment with empty Card Number
select etr.EFTTransmissionRequestId,
eft.DrawDate,
cast(EFTTransmissionData as xml).value('(/EFTTransmissionData/AccountReference)[1]','nvarchar(max)') as BillingAccountNumber,
eft.TransmissionStatusCode,
etr.*
from PRD_DuckCreek_Consolidated.dbo.DC_BIL_EFTTransmissionRequest etr with(nolock)
inner join PRD_DuckCreek_Consolidated.dbo.DC_BIL_EFTTransmissionControl eft with(nolock)
on etr.EFTTransmissionId = eft.EFTTransmissionId
--where EFTTransmissionId = '1348' 
where statuscode in ('A','I')
and PaymentMethodCode in ('RCC','1XCC')
-- where EFTTransmissionId = '1557' and
and ( (cast(EFTTransmissionData as xml).value('(/EFTTransmissionData/CardNumber)[1]','nvarchar(max)') = '')
or (cast(EFTTransmissionData as xml).value('/','nvarchar(max)') = '')
or EFTTransmissionData is Null
)
order by 1

-- 8.  Payment Wallet Issue
select * From DC_BIL_Account with(nolock)
where AccountId IN (select AccountId 
					from dbo.DC_BIL_PaymentWalletPaymentMethodAccount with(nolock)
					where PaymentWalletPaymentMethodId IN 
						(select PaymentWalletPaymentMethodId 
						From [PRD_DuckCreek_Consolidated].dbo.[DC_BIL_PaymentWalletPaymentMethod] with(nolock)
						where PaymentMethodId IN 
							( select PaymentMethodId From [dbo].[DC_BIL_PaymentMethod] with(nolock)
								where PaymentMethodId IN (
									select PaymentMethodId 
									from [PRD_DuckCreek_Consolidated].dbo.[DC_BIL_PaymentWalletPaymentMethod] with(nolock) 
									where PaymentWalletPaymentMethodId IN 
										( select PaymentWalletPaymentMethodId 
										from [PRD_DuckCreek_Consolidated].dbo.DC_BIL_PaymentWalletPaymentMethodAccount with(nolock)
										where AccountId IN 
											( select AccountId 
												From [PRD_DuckCreek_Consolidated].dbo.DC_BIL_Account with(nolock)
												where cast(AccountConfig as xml).value('(/AccountConfig/Scheduling/@PlanCode)[1]','nvarchar(max)') NOT IN ('HIG_ACT_A6','HIG_ACT_A5','HIG_ACT_A7')))) and ( cast(PaymentMethodDetail as xml).value('(/PaymentMethodDetail)[1]','varchar(max)') = ''))
							));


--  Fridays
-- 1.  Get Transmissions with Counts - Monday thru Thursday
SELECT etc.EFTTransmissionId, DrawDate, BankId, TransmissionStatusCode, RequestTypeCode, Count(*) as Count,
		sum(cast(EFTTransmissionData as xml).value('(/EFTTransmissionData/Amount)[1]','decimal(19,4)')) as Amount
from DC_BIL_EFTTransmissionControl etc
join DC_BIL_EFTTransmissionRequest etr
on etc.EFTTransmissionId = etr.EFTTransmissionId
where ((drawdate <= CONVERT(date, getdate()) and BankId = 5) or
      (drawdate <= CONVERT(date, getdate()+3) and BankId = 1))
and TransmissionStatusCode in ('A','I') 
and StatusCode in ('A','I')
group by etc.EFTTransmissionId, DrawDate, BankId, TransmissionStatusCode, RequestTypeCode
order by BankId, EFTTransmissionId

-- 2.  Get Transmissions with both Debit and Credit
select EFTTransmissionId, count(distinct RequestTypeCode) as CountRequestTypeCode
from DC_BIL_EFTTransmissionRequest
where EFTTransmissionId in (
		select EFTTransmissionId from DC_BIL_EFTTransmissionControl 
		where ((drawdate <= CONVERT(date, getdate()) and BankId = 5) or
			(drawdate <= CONVERT(date, getdate()+3) and BankId = 1))
			and TransmissionStatusCode in ('A','I') )
and StatusCode in ('A','I')
group by EFTTransmissionId
having count(distinct RequestTypeCode) > 1
order by 1,2

-- 3.  Get Transmissions with Both EFT and RCC - Monday thru Thursday
select etc.EFTTransmissionId, PaymentMethodCode, count(*),
		sum(cast(EFTTransmissionData as xml).value('(/EFTTransmissionData/Amount)[1]','decimal(19,4)')) as Amount
from PRD_DuckCreek_Consolidated.dbo.DC_BIL_EFTTransmissionControl etc with(nolock)
join PRD_DuckCreek_Consolidated.dbo.DC_BIL_EFTTransmissionRequest etr with(nolock)
on etc.EFTTransmissionId = etr.EFTTransmissionId
and etc.EFTTransmissionId in (
		SELECT EFTTransmissionId
		from DC_BIL_EFTTransmissionControl 
		where ((drawdate <= CONVERT(date, getdate()) and BankId = 5) or
	      (drawdate <= CONVERT(date, getdate()+3) and BankId = 1))
		and TransmissionStatusCode in ('A','I')) 
and etr.StatusCode in ('A','I')
group by etc.EFTTransmissionId, PaymentMethodCode
order by etc.EFTTransmissionId, PaymentMethodCode

-- 4.  Bank Id Problem
select * from [PRD_DuckCreek_Consolidated].[dbo].[DC_BIL_EFTTransmissionRequest] a ,
[PRD_DuckCreek_Consolidated].[dbo].DC_BIL_EFTTransmissionControl b
where a.EFTTransmissionId=b.EFTTransmissionId and b.BankId='1' and a.PaymentMethodCode NOT IN ( '1EFT','EFT');

-- 5.  Multiple Transmissions with Same Draw Date, Bank Id, Request Type Code
select *
from DC_BIL_EFTTransmissionControl etc2
where etc2.TransmissionStatusCode in ('A','I')
and exists
(
SELECT DrawDate, BankId, TransmissionStatusCode, RequestTypeCode, Count(distinct etc.EFTTransmissionId) as Count
from DC_BIL_EFTTransmissionControl etc
join DC_BIL_EFTTransmissionRequest etr
on etc.EFTTransmissionId = etr.EFTTransmissionId
where ((drawdate <= CONVERT(date, getdate()) and BankId = 5) or
      (drawdate <= CONVERT(date, getdate()+3) and BankId = 1))
and TransmissionStatusCode in ('A','I') 
and StatusCode in ('A','I')
and etc.DrawDate = etc2.DrawDate
and etc.BankId = etc.Bankid
group by DrawDate, BankId, TransmissionStatusCode, RequestTypeCode
having Count(distinct etc.EFTTransmissionId) > 1)


--  6. ACH Payment with empty Bank Account Number/Bank Routing Number
select etr.EFTTransmissionRequestId,
cast(EFTTransmissionData as xml).value('(/EFTTransmissionData/AccountReference)[1]','nvarchar(max)') as BillingAccountNumber,
cast(EFTTransmissionData as xml).value('(/EFTTransmissionData/BankAccountNumber)[1]','nvarchar(max)'),
cast(EFTTransmissionData as xml).value('(/EFTTransmissionData/BankRoutingNumber)[1]','nvarchar(max)'),
*
from PRD_DuckCreek_Consolidated.dbo.DC_BIL_EFTTransmissionRequest etr with(nolock)
where statuscode in ('A','I')
and PaymentMethodCode in ('EFT','1EFT')
and (cast(EFTTransmissionData as xml).value('(/EFTTransmissionData/BankAccountNumber)[1]','nvarchar(max)') = ''
or cast(EFTTransmissionData as xml).value('(/EFTTransmissionData/BankRoutingNumber)[1]','nvarchar(max)') = ''
or cast(EFTTransmissionData as xml).value('(/EFTTransmissionData/BankAccountNumber)[1]','nvarchar(max)') is NULL
or cast(EFTTransmissionData as xml).value('(/EFTTransmissionData/BankRoutingNumber)[1]','nvarchar(max)') is NULL)

--  7.  CC Payment with empty Card Number
select etr.EFTTransmissionRequestId,
eft.DrawDate,
cast(EFTTransmissionData as xml).value('(/EFTTransmissionData/AccountReference)[1]','nvarchar(max)') as BillingAccountNumber,
eft.TransmissionStatusCode,
etr.*
from PRD_DuckCreek_Consolidated.dbo.DC_BIL_EFTTransmissionRequest etr with(nolock)
inner join PRD_DuckCreek_Consolidated.dbo.DC_BIL_EFTTransmissionControl eft with(nolock)
on etr.EFTTransmissionId = eft.EFTTransmissionId
--where EFTTransmissionId = '1348' 
where statuscode in ('A','I')
and PaymentMethodCode in ('RCC','1XCC')
-- where EFTTransmissionId = '1557' and
and (cast(EFTTransmissionData as xml).value('(/EFTTransmissionData/CardNumber)[1]','nvarchar(max)') = '')
order by 1

-- 8.  Payment Wallet Issue
select * From DC_BIL_Account with(nolock)
where AccountId IN (select AccountId 
					from dbo.DC_BIL_PaymentWalletPaymentMethodAccount with(nolock)
					where PaymentWalletPaymentMethodId IN 
						(select PaymentWalletPaymentMethodId 
						From [PRD_DuckCreek_Consolidated].dbo.[DC_BIL_PaymentWalletPaymentMethod] with(nolock)
						where PaymentMethodId IN 
							( select PaymentMethodId From [dbo].[DC_BIL_PaymentMethod] with(nolock)
								where PaymentMethodId IN (
									select PaymentMethodId 
									from [PRD_DuckCreek_Consolidated].dbo.[DC_BIL_PaymentWalletPaymentMethod] with(nolock) 
									where PaymentWalletPaymentMethodId IN 
										( select PaymentWalletPaymentMethodId 
										from [PRD_DuckCreek_Consolidated].dbo.DC_BIL_PaymentWalletPaymentMethodAccount with(nolock)
										where AccountId IN 
											( select AccountId 
												From [PRD_DuckCreek_Consolidated].dbo.DC_BIL_Account with(nolock)
												where cast(AccountConfig as xml).value('(/AccountConfig/Scheduling/@PlanCode)[1]','nvarchar(max)') NOT IN ('HIG_ACT_A6','HIG_ACT_A5','HIG_ACT_A7')))) 
												and ( cast(PaymentMethodDetail as xml).value('(/PaymentMethodDetail)[1]','varchar(max)') = ''))
							));

-- Other queries

--  1a.  Get transmissions to be processed Monday thru Thursday
SELECT EFTTransmissionId, DrawDate, BankId, TransmissionStatusCode
from DC_BIL_EFTTransmissionControl 
where ((drawdate <= CONVERT(date, getdate()) and BankId = 5) or
      (drawdate <= CONVERT(date, getdate()+1) and BankId = 1))
and TransmissionStatusCode in ('A','I') 
order by EFTTransmissionId



--  1b.  Get transmissions for Draw Date
SELECT EFTTransmissionId, DrawDate, BankId, TransmissionStatusCode
FROM dbo.DC_BIL_EFTTransmissionControl with (nolock)
WHERE TransmissionStatusCode IN ('A', 'I')
and DrawDate < '06/23/2022 23:59:59'
order by EFTTransmissionId

--  1c.  Get transmissions to be processed Friday
SELECT EFTTransmissionId, DrawDate, BankId, TransmissionStatusCode
from DC_BIL_EFTTransmissionControl 
where ((drawdate <= CONVERT(date, getdate()) and BankId = 5) or
      (drawdate <= CONVERT(date, getdate()+3) and BankId = 1))
and TransmissionStatusCode in ('A','I') 
order by BankId,
EFTTransmissionId

SELECT etc.EFTTransmissionId, DrawDate, BankId, TransmissionStatusCode, RequestTypeCode, Count(*) as Count
from DC_BIL_EFTTransmissionControl etc
join DC_BIL_EFTTransmissionRequest etr
on etc.EFTTransmissionId = etr.EFTTransmissionId
where ((drawdate <= CONVERT(date, getdate()) and BankId = 5) or
      (drawdate <= CONVERT(date, getdate()+3) and BankId = 1))
and TransmissionStatusCode in ('A','I') 
and StatusCode in ('A','I')
group by etc.EFTTransmissionId, DrawDate, BankId, TransmissionStatusCode, RequestTypeCode
order by EFTTransmissionId




-- 2b.   Get Count of Transmission Request Ids by Type
select EFTTransmissionId, RequestTypeCode, count(*)
from DC_BIL_EFTTransmissionRequest
where EFTTransmissionId in (
		select EFTTransmissionId from DC_BIL_EFTTransmissionControl 
		where ((drawdate <= CONVERT(date, getdate()) and BankId = 5) or
		(drawdate <= CONVERT(date, getdate()+1) and BankId = 1))
		and TransmissionStatusCode in ('A','I') )
and StatusCode in ('A','I')
group by EFTTransmissionId, RequestTypeCode
order by 1,2


-- 2c.  Get Transmissions with both Debit and Credit - FRIDAY
select EFTTransmissionId, count(distinct RequestTypeCode) as CountRequestTypeCode
from DC_BIL_EFTTransmissionRequest
where EFTTransmissionId in (
		select EFTTransmissionId from DC_BIL_EFTTransmissionControl 
		where ((drawdate <= CONVERT(date, getdate()) and BankId = 5) or
			(drawdate <= CONVERT(date, getdate()+3) and BankId = 1))
			and TransmissionStatusCode in ('A','I') )
and StatusCode in ('A','I')
group by EFTTransmissionId
having count(distinct RequestTypeCode) > 1
order by 1,2

-- 2d.   Get Count of Transmission Request Ids by Type - FRIDAY
select EFTTransmissionId, RequestTypeCode, count(*)
from DC_BIL_EFTTransmissionRequest
where EFTTransmissionId in (
		select EFTTransmissionId from DC_BIL_EFTTransmissionControl 
		where ((drawdate <= CONVERT(date, getdate()) and BankId = 5) or
		(drawdate <= CONVERT(date, getdate()+3) and BankId = 1))
		and TransmissionStatusCode in ('A','I') )
and StatusCode in ('A','I')
group by EFTTransmissionId, RequestTypeCode
order by 1,2

-- 2c.  Get Request Type Codes for a file
select *
from DC_BIL_EFTTransmissionRequest
-- where EFTTransmissionRequestId in 
-- (155268, 155247, 155536, 154060, 153633, 132512, 130276, 149348, 137814, 140729, 140721, 155477, 155471, 155517, 155508, 155675, 155344, 156258, 155320, 155304, 155376, 155374, 156255, 149187, 155416, 155396, 155636, 155626, 155622, 155603, 156251, 156334, 155454)
where EFTTransmissionId = 1630



-- 2e.  Get Transmissions with Both EFT and RCC - Friday
select etc.EFTTransmissionId, PaymentMethodCode, count(*)
from PRD_DuckCreek_Consolidated.dbo.DC_BIL_EFTTransmissionControl etc with(nolock)
join PRD_DuckCreek_Consolidated.dbo.DC_BIL_EFTTransmissionRequest etr with(nolock)
on etc.EFTTransmissionId = etr.EFTTransmissionId
and etc.EFTTransmissionId in (
		SELECT EFTTransmissionId
		from DC_BIL_EFTTransmissionControl 
		where ((drawdate <= CONVERT(date, getdate()) and BankId = 5) or
	      (drawdate <= CONVERT(date, getdate()+3) and BankId = 1))
		and TransmissionStatusCode in ('A','I')) 
and etr.StatusCode in ('A','I')
group by etc.EFTTransmissionId, PaymentMethodCode
order by etc.EFTTransmissionId, PaymentMethodCode



-- 2h.  Multiple Transmissions with Same Draw Date, Bank Id, Request Type Code - FRIDAY
select *
from DC_BIL_EFTTransmissionControl etc2
where etc2.TransmissionStatusCode in ('A','I')
and exists
(
SELECT DrawDate, BankId, TransmissionStatusCode, RequestTypeCode, Count(distinct etc.EFTTransmissionId) as Count
from DC_BIL_EFTTransmissionControl etc
join DC_BIL_EFTTransmissionRequest etr
on etc.EFTTransmissionId = etr.EFTTransmissionId
where ((drawdate <= CONVERT(date, getdate()) and BankId = 5) or
      (drawdate <= CONVERT(date, getdate()+3) and BankId = 1))
and TransmissionStatusCode in ('A','I') 
and StatusCode in ('A','I')
and etc.DrawDate = etc2.DrawDate
and etc.BankId = etc.Bankid
group by DrawDate, BankId, TransmissionStatusCode, RequestTypeCode
having Count(distinct etc.EFTTransmissionId) > 1)


--  3a.  Credit Cards Transmissions
select top 9999 
       eft.EFTTransmissionRequestId,
	   eft.EFTraceReference,
       eft.EFTTransmissionId,
  	   eft.AccountId,
       act.accountreference, 
       eft.RequestTypeCode,
       eft.StatusCode,
cast(EFTTransmissionData as xml).value('(/EFTTransmissionData/DrawDate)[1]','nvarchar(max)') as DrawDate,
cast(EFTTransmissionData as xml).value('(/EFTTransmissionData/Amount)[1]','nvarchar(max)') as Amount,
cast(eft.EFTTransmissionData as xml).value('(/EFTTransmissionData/Token/PaymentProfileID)[1]','nvarchar(max)') as PaymentProfileID,
cast(eft.EFTTransmissionData as xml).value('(/EFTTransmissionData/CardTransactionDetails/NameOnCard)[1]','nvarchar(max)') as NameOnCard,
cast(eft.EFTTransmissionData as xml).value('(/EFTTransmissionData/CardNumber)[1]','nvarchar(max)') as CardNumber,
cast(eft.EFTTransmissionData as xml).value('(/EFTTransmissionData/ExpirationDate)[1]','nvarchar(max)') as ExpirationDate,
cast(eft.EFTTransmissionData as xml).value('(/EFTTransmissionData/CardType)[1]','nvarchar(max)') as CardType
-- select *
-- select distinct RequestTypeCode
from   PRD_DuckCreek_Consolidated.dbo.DC_BIL_EFTTransmissionRequest eft with(nolock)
join   PRD_DuckCreek_Consolidated.dbo.DC_BIL_Account act with(nolock)
on act.AccountID = eft.AccountID
join    PRD_DuckCreek_Consolidated.dbo.DC_BIL_EFTTransmissionControl etc
on eft.EFTTransmissionId = etc.EFTTransmissionId
where eft.EFtTransmissionId in (1606)
--  and act.AccountReference = 32000799
and StatusCode in ('A', 'I')
-- where eft.EFtTransmissionRequestId in (

-- 3b.  ACH Transmissions
select eft.EFTTransmissionRequestId,
	   eft.EFTraceReference,
       eft.EFTTransmissionId,
  	   eft.AccountId,
       act.accountreference, 
       eft.RequestTypeCode,
       eft.StatusCode,
		cast(eft.EFTTransmissionData as xml).value('(//EFTTransmissionData/PayorName)[1]','nvarchar(max)') as PayorName,
		cast(eft.EFTTransmissionData as xml).value('(/EFTTransmissionData/BankRoutingNumber)[1]','nvarchar(max)') as BankRoutingNumber,
		cast(eft.EFTTransmissionData as xml).value('(//EFTTransmissionData/BankAccountNumber)[1]','nvarchar(max)') as BankAccountNumber,
		cast(eft.EFTTransmissionData as xml).value('(/EFTTransmissionData/Amount)[1]','nvarchar(max)') as Amount
-- select *
from   PRD_DuckCreek_Consolidated.dbo.DC_BIL_EFTTransmissionRequest eft with(nolock)
join   PRD_DuckCreek_Consolidated.dbo.DC_BIL_Account act with(nolock)
on act.AccountID = eft.AccountID
join    PRD_DuckCreek_Consolidated.dbo.DC_BIL_EFTTransmissionControl etc
on eft.EFTTransmissionId = etc.EFTTransmissionId
and eft.StatusCode in ('A','I')
and PaymentMethodCode in ('1EFT','EFT')
-- and AccountStateCode not in ('TX')
-- and etc.EFTTransmissionId in (1633)
and eft.EFTTransmissionId in (1439, 1637, 1638, 1643)
-- and act.AccountReference = 32000799


--  4a.  CC Transmission Requests with No Payment Wallet Entry 
WITH TransmissionDetail (
		AccountReference,
		PaymentProfileID, 
		NameOnCard,
		CardNumber,
		ExpirationDate,
		CardType,
		RequestTypeCode)
AS  
(
select act.accountreference,
		cast(eft.EFTTransmissionData as xml).value('(/EFTTransmissionData/Token/PaymentProfileID)[1]','nvarchar(max)') as PaymentProfileID,
		cast(eft.EFTTransmissionData as xml).value('(/EFTTransmissionData/CardTransactionDetails/NameOnCard)[1]','nvarchar(max)') as NameOnCard,
		cast(eft.EFTTransmissionData as xml).value('(/EFTTransmissionData/CardNumber)[1]','nvarchar(max)') as CardNumber,
		cast(eft.EFTTransmissionData as xml).value('(/EFTTransmissionData/ExpirationDate)[1]','nvarchar(max)') as ExpirationDate,
		cast(eft.EFTTransmissionData as xml).value('(/EFTTransmissionData/CardType)[1]','nvarchar(max)') as CardType,
		eft.RequestTypeCode
from   PRD_DuckCreek_Consolidated.dbo.DC_BIL_EFTTransmissionRequest eft with(nolock)
join   PRD_DuckCreek_Consolidated.dbo.DC_BIL_Account act with(nolock)
on act.AccountID = eft.AccountID
join    PRD_DuckCreek_Consolidated.dbo.DC_BIL_EFTTransmissionControl etc
on eft.EFTTransmissionId = etc.EFTTransmissionId
 and eft.StatusCode in ('A','I')
-- and eft.StatusCode in ('A','I','T')
-- and PaymentMethodCode in ('1XCC','RCC')
-- and AccountStateCode not in ('TX')
-- and etc.EFTTransmissionId in (1635)
and eft.EFTTransmissionId in (1397,1649,1661)
--and eft.EFTTransmissionId in
--( SELECT EFTTransmissionId
--from DC_BIL_EFTTransmissionControl 
--where ((drawdate <= CONVERT(date, getdate()) and BankId = 5) or
--      (drawdate <= CONVERT(date, getdate()+1) and BankId = 1))
--and TransmissionStatusCode in ('A','I') )
-- and eft.EFTTransmissionRequestId in (147001, 147000, 147004, 147005)

),
PaymentWallet (
	ObjectReference,
	PaymentProfileID, 
	NameOnCard,
	CardNumber,
	ExpirationDate,
	CardType)
AS  
(
select 
pinv.Objectreference,
cast(pm.PaymentMethodDetail as xml).value('(/PaymentMethodDetail/CardPaymentDetails/Token/PaymentProfileID)[1]','nvarchar(max)') as PaymentProfileID,
cast(pm.PaymentMethodDetail as xml).value('(/PaymentMethodDetail/CardPaymentDetails/CardTransactionDetails/NameOnCard)[1]','nvarchar(max)') as NameOnCard,
cast(pm.PaymentMethodDetail as xml).value('(/PaymentMethodDetail/CardPaymentDetails/CardNumber)[1]','nvarchar(max)') as CardNumber,
cast(pm.PaymentMethodDetail as xml).value('(/PaymentMethodDetail/CardPaymentDetails/ExpirationDate)[1]','nvarchar(max)') as ExpirationDate,
cast(pm.PaymentMethodDetail as xml).value('(/PaymentMethodDetail/CardPaymentDetails/CardType)[1]','nvarchar(max)') as CardType
from DC_BIL_PaymentMethod pm
join DC_BIL_PaymentWalletPaymentMethod pwpm on pm.PaymentMethodId = pwpm.PaymentMethodId
join DC_BIL_PaymentWallet pw on pwpm.PaymentWalletId = pw.PaymentWalletId
join DC_PLT_PartyInvolvement pinv on pw.PartyId = pinv.PartyId
join DC_BIL_Account act with(nolock) on pinv.ObjectReference= act.accountreference
join DC_BIL_EFTTransmissionRequest eft on act.accountId = eft.AccountId 
where cast(pm.PaymentMethodDetail as xml).value('(/PaymentMethodDetail/CardPaymentDetails/Token/PaymentProfileID)[1]','nvarchar(max)') is not null
and act.AccountId = 39744
-- and eft.EFTTransmissionId in (1397,1649,1661)
--and eft.EFTTransmissionId in
--( SELECT EFTTransmissionId
--from DC_BIL_EFTTransmissionControl 
--where ((drawdate <= CONVERT(date, getdate()) and BankId = 5) or
--      (drawdate <= CONVERT(date, getdate()+1) and BankId = 1))
--and TransmissionStatusCode in ('A','I') )
)

select *
from TransmissionDetail td
where not exists (
select 1
from PaymentWallet pw
where td.AccountReference = pw.ObjectReference
and td.PaymentProfileID = pw.PaymentProfileId)
order by AccountReference

--  4b.  ACH Transmission Requests with No Payment Wallet Entry 
WITH 
TransmissionDetail (
		AccountReference,
		PayorName, 
		BankRoutingNumber,
		BankAccountNumber,
		Amount)
AS  
(
select act.accountreference,
		cast(eft.EFTTransmissionData as xml).value('(//EFTTransmissionData/PayorName)[1]','nvarchar(max)') as PayorName,
		cast(eft.EFTTransmissionData as xml).value('(/EFTTransmissionData/BankRoutingNumber)[1]','nvarchar(max)') as BankRoutingNumber,
		cast(eft.EFTTransmissionData as xml).value('(//EFTTransmissionData/BankAccountNumber)[1]','nvarchar(max)') as BankAccountNumber,
		cast(eft.EFTTransmissionData as xml).value('(/EFTTransmissionData/Amount)[1]','nvarchar(max)') as Amount
from   PRD_DuckCreek_Consolidated.dbo.DC_BIL_EFTTransmissionRequest eft with(nolock)
join   PRD_DuckCreek_Consolidated.dbo.DC_BIL_Account act with(nolock)
on act.AccountID = eft.AccountID
join    PRD_DuckCreek_Consolidated.dbo.DC_BIL_EFTTransmissionControl etc
on eft.EFTTransmissionId = etc.EFTTransmissionId
csr1where etc.EFTTransmissionId in (1633)
and eft.StatusCode in ('A','I')
and PaymentMethodCode in ('1EFT','EFT')
-- and AccountStateCode not in ('TX')
-- and act.accountReference = 32000188
-- and eft.EFTraceReference in 
-- (153129, 153131, 153132, 153136, 153130, 153138, 153133, 153137, 153135, 153134, 153127, 153165) 
-- 5210125955

),
PaymentWallet (
	ObjectReference,
	AccountName,
	BankRoutingNumber,
	BankAccountNumber)
AS  
(
select 
pinv.Objectreference,
cast(pm.PaymentMethodDetail as xml).value('(/PaymentMethodDetail/EFTPaymentDetails/AccountName)[1]','nvarchar(max)') as AccountName,
cast(pm.PaymentMethodDetail as xml).value('(/PaymentMethodDetail/EFTPaymentDetails/BankRoutingNumber)[1]','nvarchar(max)') as BankRoutingNumber,
cast(pm.PaymentMethodDetail as xml).value('(/PaymentMethodDetail/EFTPaymentDetails/BankAccountNumber)[1]','nvarchar(max)') as BankAccountNumber
from DC_BIL_PaymentMethod pm
join DC_BIL_PaymentWalletPaymentMethod pwpm on pm.PaymentMethodId = pwpm.PaymentMethodId
join DC_BIL_PaymentWallet pw on pwpm.PaymentWalletId = pw.PaymentWalletId
join DC_PLT_PartyInvolvement pinv on pw.PartyId = pinv.PartyId
join DC_BIL_Account act with(nolock) on pinv.ObjectReference= act.accountreference
join DC_BIL_EFTTransmissionRequest eft on act.accountId = eft.AccountId 
where cast(pm.PaymentMethodDetail as xml).value('(/PaymentMethodDetail/EFTPaymentDetails/BankAccountNumber)[1]','nvarchar(max)') is not null
-- and eft.EFTTransmissionId in (1633)
and eft.EFTTransmissionId in (1439, 1637, 1638, 1643)
-- and act.AccountReference = 32000188
and StatusCode in ('A','I')
and PaymentMethodCode in ('1EFT','EFT')
-- and AccountStateCode not in ('TX')
-- and eft.EFTraceReference in 
-- (153129, 153131, 153132, 153136, 153130, 153138, 153133, 153137, 153135, 153134, 153127, 153165) 
)

select *
from TransmissionDetail td
where not exists (
select 1
from PaymentWallet pw
where td.AccountReference = pw.ObjectReference
and td.BankAccountNumber = pw.BankAccountNumber)
-- order by AccountReference

--  5a.  Transmission Request Bank Account Number does not match Payment Wallet 
select 
		pinv.Objectreference,
		cast(eft.EFTTransmissionData as xml).value('(//EFTTransmissionData/PayorName)[1]','nvarchar(max)') as PayorName,
		cast(eft.EFTTransmissionData as xml).value('(//EFTTransmissionData/BankAccountNumber)[1]','nvarchar(max)') as BankAccountNumber,
		cast(eft.EFTTransmissionData as xml).value('(/EFTTransmissionData/BankRoutingNumber)[1]','nvarchar(max)') as BankRoutingNumber,
		cast(eft.EFTTransmissionData as xml).value('(/EFTTransmissionData/Amount)[1]','nvarchar(max)') as Amount,
		cast(pm.PaymentMethodDetail as xml).value('(/PaymentMethodDetail/EFTPaymentDetails/AccountName)[1]','nvarchar(max)') as AccountName,
		cast(pm.PaymentMethodDetail as xml).value('(/PaymentMethodDetail/EFTPaymentDetails/BankAccountNumber)[1]','nvarchar(max)') as BankAccountNumber,
		cast(pm.PaymentMethodDetail as xml).value('(/PaymentMethodDetail/EFTPaymentDetails/BankRoutingNumber)[1]','nvarchar(max)') as BankRoutingNumber,
		cast(pm.PaymentMethodDetail as xml).value('(/PaymentMethodDetail/EFTPaymentDetails/PaymentMethodId)[1]','nvarchar(max)') as PaymentMethodId,
		eft.RequestTypeCode,
		pm.PaymentMethodId,
		eft.AccountId
from DC_BIL_PaymentMethod pm
join DC_BIL_PaymentWalletPaymentMethod pwpm on pm.PaymentMethodId = pwpm.PaymentMethodId
join DC_BIL_PaymentWallet pw on pwpm.PaymentWalletId = pw.PaymentWalletId
join DC_PLT_PartyInvolvement pinv on pw.PartyId = pinv.PartyId
join DC_BIL_Account act with(nolock) on act.Accountreference = pinv.ObjectReference
join DC_BIL_EFTTransmissionRequest eft on act.AccountId = eft.AccountId
join DC_BIL_EFTTransmissionControl etc on eft.EFTTransmissionId = etc.EFTTransmissionId
-- where etc.EFTTransmissionId in (1334,1534,1597,1599,1600)
where eft.EFTTransmissionId in (1483, 1679)
-- and eft.EFTraceReference in 
-- where eft.EFTTransmissionRequestId in (140676)
--  and StatusCode in ('A','I')
 and PaymentMethodCode in ('1EFT','EFT')
-- and AccountStateCode not in ('TX')
and cast(pm.PaymentMethodDetail as xml).value('(/PaymentMethodDetail/EFTPaymentDetails/BankAccountNumber)[1]','nvarchar(max)') is not null
 and cast(eft.EFTTransmissionData as xml).value('(/EFTTransmissionData/BankAccountNumber)[1]','nvarchar(max)') <>
  cast(pm.PaymentMethodDetail as xml).value('(/PaymentMethodDetail/EFTPaymentDetails/BankAccountNumber)[1]','nvarchar(max)')
-- and right(cast(eft.EFTTransmissionData as xml).value('(/EFTTransmissionData/BankAccountNumber)[1]','nvarchar(max)'),4) <>
--   right(cast(pm.PaymentMethodDetail as xml).value('(/PaymentMethodDetail/EFTPaymentDetails/BankAccountNumber)[1]','nvarchar(max)'),4)
 and pinv.ObjectReference in ( '32007429')
and pinv.RoleCode = 'P'

;


--  5b.  Transmission Request Credit Card Number does not match Payment Wallet 
select distinct
		pinv.Objectreference,
		cast(eft.EFTTransmissionData as xml).value('(/EFTTransmissionData/Token/PaymentProfileID)[1]','nvarchar(max)') as PaymentProfileID,
		cast(eft.EFTTransmissionData as xml).value('(/EFTTransmissionData/CardTransactionDetails/NameOnCard)[1]','nvarchar(max)') as NameOnCard,
		cast(eft.EFTTransmissionData as xml).value('(/EFTTransmissionData/CardNumber)[1]','nvarchar(max)') as CardNumber,
		cast(eft.EFTTransmissionData as xml).value('(/EFTTransmissionData/ExpirationDate)[1]','nvarchar(max)') as ExpirationDate,
		cast(eft.EFTTransmissionData as xml).value('(/EFTTransmissionData/CardType)[1]','nvarchar(max)') as CardType,
		cast(pm.PaymentMethodDetail as xml).value('(/PaymentMethodDetail/CardPaymentDetails/Token/PaymentProfileID)[1]','nvarchar(max)') as PaymentProfileID,
		cast(pm.PaymentMethodDetail as xml).value('(/PaymentMethodDetail/CardPaymentDetails/CardTransactionDetails/NameOnCard)[1]','nvarchar(max)') as NameOnCard,
		cast(pm.PaymentMethodDetail as xml).value('(/PaymentMethodDetail/CardPaymentDetails/CardNumber)[1]','nvarchar(max)') as CardNumber,
		cast(pm.PaymentMethodDetail as xml).value('(/PaymentMethodDetail/CardPaymentDetails/ExpirationDate)[1]','nvarchar(max)') as ExpirationDate,
		cast(pm.PaymentMethodDetail as xml).value('(/PaymentMethodDetail/CardPaymentDetails/CardType)[1]','nvarchar(max)') as CardType,
		eft.RequestTypeCode
from DC_BIL_PaymentMethod pm
join DC_BIL_PaymentWalletPaymentMethod pwpm on pm.PaymentMethodId = pwpm.PaymentMethodId
join DC_BIL_PaymentWallet pw on pwpm.PaymentWalletId = pw.PaymentWalletId
join DC_PLT_PartyInvolvement pinv on pw.PartyId = pinv.PartyId
join DC_BIL_Account act with(nolock) on act.Accountreference = pinv.ObjectReference
join DC_BIL_EFTTransmissionRequest eft on act.AccountId = eft.AccountId
join DC_BIL_EFTTransmissionControl etc on eft.EFTTransmissionId = etc.EFTTransmissionId
-- where etc.EFTTransmissionId in (1334,1534,1597,1599,1600)
where etc.EFTTransmissionId in (1635)
 and StatusCode in ('A','I')
 and PaymentMethodCode in ('1XCC','RCC')
-- and AccountStateCode not in ('TX')
and cast(pm.PaymentMethodDetail as xml).value('(/PaymentMethodDetail/CardPaymentDetails/Token/PaymentProfileID)[1]','nvarchar(max)') is not null
 and cast(eft.EFTTransmissionData as xml).value('(/EFTTransmissionData/Token/PaymentProfileID)[1]','nvarchar(max)') <>
  cast(pm.PaymentMethodDetail as xml).value('(/PaymentMethodDetail/CardPaymentDetails/Token/PaymentProfileID)[1]','nvarchar(max)')
-- and pinv.ObjectReference in ( 
order by 1


--  TEST - CAN DELETE

select 
pinv.Objectreference,
cast(pm.PaymentMethodDetail as xml).value('(/PaymentMethodDetail/CardPaymentDetails/Token/PaymentProfileID)[1]','nvarchar(max)') as PaymentProfileID,
cast(pm.PaymentMethodDetail as xml).value('(/PaymentMethodDetail/CardPaymentDetails/CardTransactionDetails/NameOnCard)[1]','nvarchar(max)') as NameOnCard,
cast(pm.PaymentMethodDetail as xml).value('(/PaymentMethodDetail/CardPaymentDetails/CardNumber)[1]','nvarchar(max)') as CardNumber,
cast(pm.PaymentMethodDetail as xml).value('(/PaymentMethodDetail/CardPaymentDetails/ExpirationDate)[1]','nvarchar(max)') as ExpirationDate,
cast(pm.PaymentMethodDetail as xml).value('(/PaymentMethodDetail/CardPaymentDetails/CardType)[1]','nvarchar(max)') as CardType,
cast(pm.PaymentMethodDetail as xml).value('(/PaymentMethodDetail/CardPaymentDetails/CardType)[1]','nvarchar(max)') as CardType,

pm.*
--from DC_BIL_PaymentMethod pm
from DC_BIL_PaymentMethodHistory pm
join DC_BIL_PaymentWalletPaymentMethod pwpm on pm.PaymentMethodId = pwpm.PaymentMethodId
join DC_BIL_PaymentWallet pw on pwpm.PaymentWalletId = pw.PaymentWalletId
join DC_PLT_PartyInvolvement pinv on pw.PartyId = pinv.PartyId
-- join DC_BIL_Account act with(nolock) on pinv.ObjectReference= act.accountreference
-- join DC_BIL_EFTTransmissionRequest eft on act.accountId = eft.AccountId 
where 
-- cast(pm.PaymentMethodDetail as xml).value('(/PaymentMethodDetail/CardPaymentDetails/Token/PaymentProfileID)[1]','nvarchar(max)') is not null
-- and pinv.ObjectReference = '32014950'
pw.PartyId in ('08D989D9B0D3D9A3')

select *
from DC_PLT_PartyInvolvement pinv
where pinv.ObjectReference = '32014950'

select *
from DC_BIL_PaymentWallet
where PartyId in ('08D989D9B0D3D9A3')

select *
from DC_BIL_PaymentWalletPaymentMethod
where PaymentWalletId = 12858

select *
from DC_BIL_PaymentMethodHistory
where PaymentMethodId in (
select PaymentMethodid
from DC_BIL_PaymentWalletPaymentMethod
where PaymentWalletId = 12858)

select *
from DC_BIL_PaymentMethod
where PaymentMethodId =17508

select  *
from DC_BIL_PaymentBatchEntry
where PaymentBatchId = 1094

select *
from dc_bil_account
where AccountReference = '32014950'

select *
from DC_Bil_Payment with(nolock)
-- where InitialAllocationAccountId =14950 
where PaymentBatchId =1094
order by InitialAllocationAccountId desc

select *
from DC_BIL_EFTTransmissionRequest
where EFTTransmissionRequestId = 141702
-- where PaymentBatchId  = 1032
where AccountId = 14950

select top 100 *
from DC_BIL_PaymentMethodHistory pm

select top 100 *
from DC_BIL_Disbursement
where DisbursementRequestDate between '2022-05-10 00:00:00' and '2022-05-11 23:00:00' 
and DisbursementMethodCode <> 'CK'
order by DisbursementRequestDate

-- select a.accountreference, d.*
select CONVERT(date, AuthorizedDateTime) as AuthorizedDate, DisbursementMethodCode, count(*)

select a.accountreference,
d.DisbursementRequestDate,
d.AuthorizedDateTime,
d.DisbursementMethodCode,
d.LastUpdatedTimestamp,
-- cast(EFTTransmissionData as xml).value('(/EFTTransmissionData/BankAccountNumber)[1]','nvarchar(max)') as BankAccountNumber,
-- cast(EFTTransmissionData as xml).value('(/EFTTransmissionData/BankRoutingNumber)[1]','nvarchar(max)') as BankRoutingNumber,
select d.disbursementId
from DC_BIL_Disbursement d
join DC_BIL_Account a
on d.accountid = a.accountId
where DisbursementRequestDate between '2022-05-10 00:00:00' and '2022-05-11 00:00:00' 
-- and DisbursementMethodCode <> 'CK'
 and disbursementStatusCode = 'R'
-- and DisbursementMethodCode in ( '1EFT', 'EFT')
-- group by CONVERT(date, AuthorizedDateTime), DisbursementMethodCode
-- order by 5 desc

select *
from DC_BIL_Disbursement d
where DisbursementId in (
8796,
8794,
8793,
8792,
8791,
8783)

select *
from DC_BIL_DisbursementHistory d
where DisbursementId in (
8796,
8794,
8793,
8792,
8791,
8783)



select CONVERT(date, AuthorizedDateTime) as AuthorizedDate, 
		CONVERT(date, DisbursementRequestDate) as DisbursementRequestDate,
		DisbursementMethodCode, count(*)
from DC_BIL_Disbursement d
where disbursementStatusCode = 'R'
group by CONVERT(date, AuthorizedDateTime), 
		CONVERT(date, DisbursementRequestDate),
DisbursementMethodCode
order by 1

select CONVERT(date, AuthorizedDateTime) as AuthorizedDate, DisbursementMethodCode, count(*)
from DC_BIL_Disbursement d
where disbursementStatusCode = 'R'
group by CONVERT(date, AuthorizedDateTime), DisbursementMethodCode
order by 1


select *
from DC_BIL_Account
where AccountId in (2891)

select 	cast(pm.PaymentMethodDetail as xml).value('(/PaymentMethodDetail/EFTPaymentDetails/AccountName)[1]','nvarchar(max)') as AccountName,
		cast(pm.PaymentMethodDetail as xml).value('(/PaymentMethodDetail/EFTPaymentDetails/BankAccountNumber)[1]','nvarchar(max)') as BankAccountNumber,
		cast(pm.PaymentMethodDetail as xml).value('(/PaymentMethodDetail/EFTPaymentDetails/BankRoutingNumber)[1]','nvarchar(max)') as BankRoutingNumber,
		cast(pm.PaymentMethodDetail as xml).value('(/PaymentMethodDetail/EFTPaymentDetails/PaymentMethodId)[1]','nvarchar(max)') as PaymentMethodId,
		pm.PaymentMethodId,
		pm.*
from DC_BIL_PaymentMethod pm with(nolock)
where PaymentMethodId in (
100612, -- 8435
7604,  -- 6398
7638)  -- 9387



select *
from DC_BIL_PaymentWalletPaymentMethodAccount pwpma
JOIN DC_BIL_PaymentWalletPaymentMethod pwpm
on pwpm.PaymentWalletPaymentMethodId = pwpma.PaymentWalletPaymentMethodId
where pwpm.PaymentMethodId in (
100612,
7604,
7638)
-- 7398 & 7428
-- Just ran the query you gave me.  So Vanessa E Dean has 2 Bill Accounts:  32007399 & 32007429.  
-- Bank Account Number in Wallet for 32007399 (Account Id 7398)  is ******6398
-- Bank Account Number in Wallet for 32007429  (Account Id 7428) is ******9387
-- Transmission Request Id 155756 uses 9387

select 	pinv.Objectreference,
		cast(pm.PaymentMethodDetail as xml).value('(/PaymentMethodDetail/EFTPaymentDetails/AccountName)[1]','nvarchar(max)') as AccountName,
		cast(pm.PaymentMethodDetail as xml).value('(/PaymentMethodDetail/EFTPaymentDetails/BankRoutingNumber)[1]','nvarchar(max)') as BankRoutingNumber,
		cast(pm.PaymentMethodDetail as xml).value('(/PaymentMethodDetail/EFTPaymentDetails/BankAccountNumber)[1]','nvarchar(max)') as BankAccountNumber,
		cast(pm.PaymentMethodDetail as xml).value('(/PaymentMethodDetail/EFTPaymentDetails/PaymentMethodId)[1]','nvarchar(max)') as PaymentMethodId,
		pm.PaymentMethodId
from DC_BIL_PaymentMethod pm
join DC_BIL_PaymentWalletPaymentMethod pwpm on pm.PaymentMethodId = pwpm.PaymentMethodId
join DC_BIL_PaymentWallet pw on pwpm.PaymentWalletId = pw.PaymentWalletId
join DC_PLT_PartyInvolvement pinv on pw.PartyId = pinv.PartyId
join DC_BIL_Account act with(nolock) on act.Accountreference = pinv.ObjectReference
and cast(pm.PaymentMethodDetail as xml).value('(/PaymentMethodDetail/EFTPaymentDetails/BankAccountNumber)[1]','nvarchar(max)') is not null
and pinv.ObjectReference in ( '32007429')
and pinv.RoleCode = 'P'

Select 	pwpma.AccountId,
		cast(pm.PaymentMethodDetail as xml).value('(/PaymentMethodDetail/EFTPaymentDetails/AccountName)[1]','nvarchar(max)') as AccountName,
		cast(pm.PaymentMethodDetail as xml).value('(/PaymentMethodDetail/EFTPaymentDetails/BankRoutingNumber)[1]','nvarchar(max)') as BankRoutingNumber,
		cast(pm.PaymentMethodDetail as xml).value('(/PaymentMethodDetail/EFTPaymentDetails/BankAccountNumber)[1]','nvarchar(max)') as BankAccountNumber,
		cast(pm.PaymentMethodDetail as xml).value('(/PaymentMethodDetail/EFTPaymentDetails/PaymentMethodId)[1]','nvarchar(max)') as PaymentMethodId,
		pm.PaymentMethodId
from DC_BIL_PaymentMethod pm
join DC_BIL_PaymentWalletPaymentMethod pwpm
on pm.PaymentMethodId = pwpm.PaymentMethodId
join DC_BIL_PaymentWalletPaymentMethodAccount pwpma
on pwpma.PaymentWalletPaymentMethodId = pwpm.PaymentWalletPaymentMethodId
where pwpma.AccountId = 7428

-- Query 1 - Used by Validation Script:
-- DC_BIL_PaymentMethod, DC_BIL_PaymentWalletPaymentMethod, DC_BIL_PaymentWallet, DC_PLT_PartyInvolvement

-- Query 2 - Sent by Lana and matches Screen
-- DC_BIL_PaymentMethod, DC_BIL_PaymentWalletPaymentMethod, DC_BIL_PaymentWalletPaymentMethodAccount


select pinv.PartyId,
pinv.ObjectReference,
pinv.RoleCode
from DC_PLT_PartyInvolvement pinv with(nolock)
where pinv.ObjectReference in ( '32007429')

select *
from DC_BIL_PaymentWallet pw with(nolock)
where PartyId = '08D94C5973238E5F'

select *
from DC_BIL_PaymentWalletPaymentMethod pwpm
where pwpm.PaymentWalletId = 7054

select *
from DC_BIL_PaymentMethod pm
where pm.PaymentMethodId in (7604, 7636, 7638, 100612)
